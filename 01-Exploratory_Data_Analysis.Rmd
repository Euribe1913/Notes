# Exploratory Data Analysis

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE, fig.height = 3, fig.width = 7, cache=TRUE)
library(ggformula)
library(moderndive)
library(gridExtra)
library(skimr)
library(Bolstad)
library(GGally)
library(Lock5Data)
library(knitr)
library(caret)
library(MASS)
library(tidyverse)
options(scipen=999)
set.seed(07302020)
```


## Exploring Diamond Prices

### The Data

We consider a dataset with prices (in $ US) and other information on 53,940 round cut diamonds. The first 6 rows are shown below. 

```{r}
library(tidyverse)
data(diamonds)
head(diamonds)
```

```{r, echo=TRUE}
diamonds$cut <- factor(x = diamonds$cut, levels = c("Fair",
                                        "Good",
                                        "Very Good",
                                        "Premium",
                                        "Ideal"), ordered = TRUE)
```




### Observations and Variables

We call the rows of the dataset **observations** and the columns **variables**. In this dataset, the observations are the diamonds, and the variables are their attributes.   
The dataset incudes both:

* **categorical (or factor) variables:** cut, color, clarity, and   
* **quantitative (or numeric) variables**, depth, table, price, x, y, z

### Exploring the Data

When encountering a new dataset, a good way to start is to create some graphs and tables that help us understand the nature of the data. 

For now, we'll focus on factors related to the price of diamonds.   

### Boxplot of Diamond Prices

```{r}
ggplot(data=diamonds, aes(x=price, y=cut, fill=cut)) + 
  geom_boxplot(outlier.size=0.01, outlier.alpha = 0.1) + 
    stat_summary(fun=mean, geom="point", shape=4, color="red", size=3)
```


### Histogram of carat size and quality of cut

Next, we examine a histogram, displaying price, cut, and carat size.  

```{r}
ggplot(data=diamonds, aes(x=carat, fill=cut)) + geom_histogram()
```


### Average carat size and price by quality of cut

```{r}
diamonds %>% group_by(cut) %>% summarize(N=n(), 
                                         Avg_carat=mean(carat), 
                                         Avg_price=mean(price) )

```

### Scatterplot of carat size and quality of cut

Next, we use a scatterplot to visualize cut, price, and carat size. 

```{r}
ggplot(data=diamonds, aes(x=carat, y=price, color=cut)) + geom_point()
```

### Thought Questions

1. Consider only the first boxplot. What do we notice about the relationship between price and cut? Is this surprising?   

2. Consider also the histogram and table. How does this information help explain the surprising result noted in Question 1?    

3. Now consider all of the plots and the table. What should we conclude about the relationship between price and quality of cut? Are better cuts generally more expensive? less expensive? about the same? Does the relationship between price and cut seem to depend on carat size?


### Terminology

The diamonds dataset is an example of two statistical concepts:

**Simpson's Paradox** refers to a situation when an apparent relationship between two variables changes or reverses when additional variable(s) are considered.     
       Example: diamonds with higher quality of cut appear less expensive than lower quality cuts, until we account for carat size
    
An **interaction** between two variables X and Y occurs when the relationship between X and a third variable Z depends on Y.     
      Example: the relationship between cut and price depends on carat size, so there is an interaction between cut and carat size.  


## Exploratory Analysis in R

This section provides examples of how to read data into R, create graphics, and calculate summary statistics. 

We'll work with data on movies released in Hollywood between 2012 and 2018.  

### Loading the Data

We'll begin by loading the `tidyverse` package, which can be used to create professional graphics, and wrangle (or manipulate) data into forms that are informative and easy to work with. 

```{r}
library(tidyverse)
```

```{r, echo=FALSE}
select <- dplyr::select
```


Next, we read in the data itself, from the website where it is stored. 

```{r}
HollywoodMovies <- read_csv("https://www.lock5stat.com/datasets3e/HollywoodMovies.csv")
```


### Previewing the Data

**`head()`**

The `head()` function displays the first 5 rows of the dataset. 

```{r}
head(HollywoodMovies)
```

**`glimpse `**

The `glimpse()` command shows the number of observations (rows), and the number of variables, (columns). We also see the name of each variable and its type. Variable types include 

* Categorical variables, which take on groups or categories, rather than numeric values. In R, these might be coded as logical `<logi>`, character `<chr>`, factor `<fct>` and ordered factor `<ord>`.  
  
* Quantitative variables, which take on meaningful numeric values. These include numeric `<num>`, integer `<int>`, and double `<dbl>`.   

```{r}
glimpse(HollywoodMovies)
```

There are 1,295 movies in the dataset, and 15 variables for each film.   

**`summary`**

`summary` displays the mean, minimum, first quartile, median, third quartile, and maximum for each numeric variable. 

```{r}
summary(HollywoodMovies)
```

Notice that 239 films have missing information on some of the variables, recorded as NA's. 

### Adding a New Variable 

We can use the `mutate()` function to create a new variable based on variables already in the dataset. 

In the data description, the variable `Profitability` is defined as *WorldGross as a percentage of Budget*. Thus, films for which `Profitability` exceeds 100 were profitable. 

We create a variable to tell whether or not a film was profitable. Note that in R, a variable defined as a condition, such as `Profitability>100` will return values of either `TRUE` or `FALSE`.   

```{r}
HollywoodMovies <- HollywoodMovies %>% mutate(Profitable = Profitability > 100)
```

```{r}
summary(HollywoodMovies$Profitable)
```


### Selecting Columns

If the dataset contains a large number of variables, narrow down to the ones you are interested in working with. This can be done with the `select()` command.  If there are not very many variables to begin with, or you are interested in all of them, then you may skip this step.

Let's narrow the dataset down to the variables `Movie`, `RottenTomatoes`, `AudienceScore`, `Genre`, `WorldGross`, `Budget`, "Profitable", and `Year`.  


```{r}
MoviesSubset <- HollywoodMovies %>% select(Movie, RottenTomatoes, AudienceScore, 
                                           Genre, WorldGross, Budget, Profitable, 
                                           Year)
```


### Filtering by Row

The `filter()` command narrows a dataset down to rows that meet specified conditions.


**Filtering by a Categorical Variable**

Let's filter the data to only include action movies, comedies, dramas, and horror movies. 

We'll also keep only those films whose budget was listed, excluding the 239 NA's. The command `!is.na()` returns only values that are not NA's. 


```{r}
MoviesSubset1 <- MoviesSubset %>% 
  filter(Genre %in% c("Action", "Comedy", "Drama", "Horror")) %>%  filter(!is.na(Budget))
```

In R, the `!` operator means "not". 


```{r}
glimpse(MoviesSubset1)
```

**Filtering by a Quantitative Variable**

Let's filter the data to only include films whose world gross exceeds 100 million dollars. 

```{r}
MoviesSubset2 <- MoviesSubset %>% filter(WorldGross >100)
```

Now, let's preview the data again. 

```{r}
glimpse(MoviesSubset2)
```

We'll use MoviesSubset1 from this point forward. 


### Histogram 

Next, we'll create graphics to help us visualize the distributions and relationships between variables. We'll use the `ggplot()` function, which is part of the `tidyverse` package. 


Histograms are useful for displaying the distribution of a single quantitative variable    

**General Template for Histogram**

```{r, eval=FALSE}
ggplot(data=DatasetName, aes(x=VariableName)) + 
  geom_histogram(fill="colorchoice", color="colorchoice") + 
  ggtitle("Plot Title") +
  xlab("x-axis label") + 
  ylab("y-axis label")
```

**Histogram of Audience Scores**

```{r}
ggplot(data=MoviesSubset1, aes(x=AudienceScore)) + 
  geom_histogram(fill="lightblue", color="white") + 
  ggtitle("Distribution of Audience Scores") +
  xlab("Audience Score") + 
  ylab("Frequency")
```

### Density Plots

Density plots show the distribution for a quantitative variable like audience score. Scores can be compared across categories, like genre.   

**General Template for Density Plot**

```{r, eval=FALSE}
ggplot(data=DatasetName, aes(x=QuantitativeVariable,
                             color=CategoricalVariable, fill=CategoricalVariable)) + 
  geom_density(alpha=0.2) + 
  ggtitle("Plot Title") +
  xlab("Axis Label") + 
  ylab("Frequency") 
```

`alpha`, ranging from 0 to 1 dictates transparency. 

**Density Plot of Audience Scores**

```{r}
ggplot(data=MoviesSubset1, aes(x=AudienceScore, color=Genre, fill=Genre)) + 
  geom_density(alpha=0.2) + 
  ggtitle("Distribution of Audience Scores") +
  xlab("Audience Score") + 
  ylab("Frequency") 
```

###  Boxplot

Boxplots can be used to compare a quantitative variable with a categorical variable

**General Template for Boxplot**

```{r, eval=FALSE}
ggplot(data=DatasetName, aes(x=CategoricalVariable, 
                             y=QuantitativeVariable)) + 
  geom_boxplot() + 
  ggtitle("Plot Title") + 
  xlab("Variable Name") + ylab("Variable Name") 
```

You can make the plot horizontal by adding `+ coordflip()`. You can turn the axis text vertical by adding `theme(axis.text.x = element_text(angle = 90))`. 

**Boxplot Comparing Scores for Genres**

```{r}
ggplot(data=MoviesSubset1, aes(x=Genre, y=AudienceScore)) + geom_boxplot() + 
  ggtitle("Audience Score by Genre") + 
  xlab("Genre") + ylab("Audience Score") + 
  theme(axis.text.x = element_text(angle = 90))
```

### Violin Plot

Violin plots are an alternative to boxplots. The width of the violin tells us the density of observations in a given range. 

**General Template for Violin Plot**

```{r, eval=FALSE}
ggplot(data=DatasetName, aes(x=CategoricalVariable, y=QuantitativeVariable, 
                             fill=CategoricalVariable)) + 
  geom_violin() + 
  ggtitle("Plot Title") + 
  xlab("Variable Name") + ylab("Variable Name") 
```

**Violin Plot Comparing Scores for Genres**

```{r}
ggplot(data=MoviesSubset1, aes(x=Genre, y=AudienceScore, fill=Genre)) + 
  geom_violin() + 
  ggtitle("Audience Score by Genre") + 
  xlab("Genre") + ylab("Audience Score") + 
  theme(axis.text.x = element_text(angle = 90))
```

We can view the boxplot and violin plot together. 

### Scatterplots   

Scatterplots are used to visualize the relationship between two quantitative variables.  

**Scatterplot Template**

```{r, eval=FALSE}
ggplot(data=DatasetName, aes(x=CategoricalVariable, y=QuantitativeVariable)) + 
  geom_point() +
  ggtitle("Plot Title") + 
  ylab("Axis Label") + 
  xlab("Axis Label")
```


**Scatterplot Comparing Audience Score and Rotten Tomatoes Score**

```{r}
ggplot(data=MoviesSubset1, aes(x=RottenTomatoes, y=AudienceScore)) + 
  geom_point() +
  ggtitle("Audience and Critics Ratings") + 
  ylab("Audience Rating") + 
  xlab("Critics' Rating")
```

We see that there is an upward trend, indicating a positive association between critics scores (RottenTomatoes), and audience scores. However, there is a lot of variability, and the relationship is moderately strong at best.   

We can also add color, size, and shape to the scatterplot to display information about other variables. 

```{r}
ggplot(data=MoviesSubset1, 
       aes(x=RottenTomatoes, y=AudienceScore, color=Genre, size=WorldGross)) + 
  geom_point() +
  ggtitle("Audience and Critics Ratings") + 
  ylab("Audience Rating") + 
  xlab("Critics' Rating")
```

We can add labels for points meeting certain conditions, using `geom_text()`. This should be done carefully, to avoid overlap. 

```{r}
ggplot(data=MoviesSubset1, 
       aes(x=RottenTomatoes, y=AudienceScore, color=Genre, size=WorldGross)) + 
  geom_point() +
  ggtitle("Audience and Critics Ratings") + 
  ylab("Audience Rating") + xlab("Critics' Rating") + 
  geom_text(data = MoviesSubset1 %>% filter(WorldGross >800), aes(label = Movie), 
            color="black", check_overlap = TRUE)
```

### Bar Graphs  

Bar graphs can be used to visualize one or more categorical variables 


**Bar Graph Template**

```{r, eval=FALSE}
ggplot(data=DatasetName, aes(x=CategoricalVariable)) + 
  geom_bar(fill="colorchoice",color="colorchoice")  + 
  ggtitle("Plot Title") + 
  xlab("Variable Name") + 
  ylab("Frequency") 
```

**Bar Graph by Genre**

```{r}
ggplot(data=MoviesSubset1, aes(x=Genre)) + 
  geom_bar(fill="lightblue",color="white")  + 
  ggtitle("Number of Films by Genre") + 
  xlab("Genre") + 
  ylab("Number of Films") +   
  theme(axis.text.x = element_text(angle = 90))
```

### Stacked and Side-by-Side Bar Graphs

**Stacked Bar Graph Template**

```{r, eval=FALSE}
ggplot(data = DatasetName, mapping = aes(x = CategoricalVariable1, 
                                         fill = CategoricalVariable2)) +
    stat_count(position="fill")  +
  theme_bw() + ggtitle("Plot Title") + 
  xlab("Variable 1") + 
  ylab("Proportion of Variable 2") +   
  theme(axis.text.x = element_text(angle = 90)) 
```


**Stacked Bar Graph Example**

The `stat_count(position="fill")` command creates a stacked bar graph, comparing two categorical variables.  Let's explore whether certain genres are more profitable than others, using the profitability variable. 

```{r}
ggplot(data = MoviesSubset1, mapping = aes(x = Genre, fill = Profitable)) +
    stat_count(position="fill")  +
  theme_bw() + ggtitle("Profitability by Genre") + 
  xlab("Genre") + 
  ylab("Proportion Profitable") +   
  theme(axis.text.x = element_text(angle = 90)) 
```


**Side-by-side Bar Graph Template**

We can create a side-by-side bar graph, using `position=dodge`. 

```{r, eval=FALSE}
ggplot(data = DatasetName, mapping = aes(x = CategoricalVariable1, 
                                         fill = CategoricalVariable2)) +
    geom_bar(position = "dodge") +
  ggtitle("Plot Title") + 
  xlab("Genre") + 
  ylab("Frequency") 
```

**Side-by-side Bar Graph Example**

```{r}
ggplot(data = MoviesSubset1, mapping = aes(x = Genre, fill = Profitable)) +
    geom_bar(position = "dodge") +
  ggtitle("Number of Films by Genre") + 
  xlab("Genre") + 
  ylab("Number of Films") +   
  theme(axis.text.x = element_text(angle = 90)) 
```


### Correlation Plot

Correlation plots can be used to visualize relationships between quantitative variables. These can be helpful when we proceed to modeling. Explanatory variables that are highly correlated with the response are often strong predictors that should be included in a model. However, including two explanatory variables that are highly correlated with one another can create interpretation problems. 

The `cor()` function calculates correlations between quantitative variables. We'll use `select_if` to select only numeric variables. The `use="complete.obs" command tells R to ignore observations with missing data. 


```{r}
cor(select_if(HollywoodMovies, is.numeric), use="complete.obs") %>% round(2)
```


The `corrplot()` function in the `corrplot()` package provides a visualization of the correlations. Larger, thicker circles indicate stronger correlations. 


```{r, fig.height=12, fig.width=12}
library(corrplot)
Corr <- cor(select_if(HollywoodMovies, is.numeric), use="complete.obs")
corrplot(Corr)
```

We can also display a numeric version of the correlations by setting `method="number"`. 

```{r, fig.height=12, fig.width=12}
Corr <- cor(select_if(HollywoodMovies, is.numeric), use="complete.obs")
corrplot(Corr, method="number")
```



### Scatterplot Matrix

A scatterplot matrix is a grid of plots. It can be created using the `ggpairs()` function in the `GGally` package. 

The scatterplot matrix shows us:  

1. Along the diagonal are density plots for quantitative variables, or bar graphs for categorical variables, showing the distribution of each variable.   
2. Under the diagonal are plots showing the relationships between the variables in the corresponding row and column. Scatterplots are used when both variables are quantitative, bar graphs are used when both variables are categorical, and boxplots are used when one variable is categorical, and the other is quantitative.    
3. Above the diagonal are correlations between quantitative variables. 

We need to remove the column with the movie names. This is done using `select`. 


```{r, fig.height=12, fig.width=12}
library(GGally)
ggpairs(MoviesSubset1 %>% select(-Movie))
```

The scatterplot matrix is useful for helping us notice key trends in our data. However, the plot can hard to read as it is quite dense, especially when there are a large number of variables. These can help us look for trends from a distance, but we should then focus in on more specific plots. 

### Summary Tables

**`group_by()` and `summarize()`**


The `group_by()` and `summarize()` commands are useful for breaking categorical variables down by category. For example, let's calculate number of films in each genre, and the mean,  median, and standard deviation in film `WorldGross` by genre. 

```{r}
MoviesSubset1 %>% group_by(Genre) %>%
  summarize(N = n(), 
            Mean_Gross = mean(WorldGross, na.rm=TRUE), 
            Median_Gross = median(WorldGross, na.rm=TRUE), 
            StDev_Gross = sd(WorldGross, na.rm = TRUE)) %>%
  arrange(desc(Mean_Gross))
```

Notes:  
1. The `n()` command calculates the number of observations in a category.    
2. The `na.rm=TRUE` command removes missing values, so that summary statistics can be calculated.  
3. `arrange(desc(Mean_Gross))` arranges the table in descending order of Mean_Gross. To arrange in ascending order, use `arrange(Mean_Gross)`. 


The `kable()` function in the `knitr()` package creates tables with professional appearance. 

```{r}
library(knitr)
MoviesTable <- MoviesSubset1 %>% group_by(Genre) %>%
  summarize(N = n(), 
            Mean_Gross = mean(WorldGross, na.rm=TRUE), 
            Median_Gross = median(WorldGross, na.rm=TRUE), 
            StDev_Gross = sd(WorldGross, na.rm = TRUE)) %>%
  arrange(desc(Mean_Gross))
kable(MoviesTable)
```


